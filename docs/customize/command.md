---
layout: doc
---
# 环境语法
> * PE内我们主要使用PECMD，全称 WinPE Commander，即 WinPE 命令解释工具进行PE环境支撑。由于其强大功能可媲美小型的集成开发环境，故也可作为应用开发平台。
> * 除了在 WinPE 环境中用于初始化并登录 Shell，还可以利用其强大自由的扩展性制作出许多简单实用的工具，如果有足够的时间和精力，你完全可以用它开发出常规的桌面应用。

# 系统变量
* `%CurDir%` — 当前目录  
* `%Desktop%` — 桌面  
* `%Programs%` — 程序  
* `%StartMenu%` — 开始菜单  
* `%Startup%` — 自动运行  
* `%QuickLaunch%` — 快速启动栏  
* `%SystemRoot%` — 系统文件夹

# 常用命令  
## `CALL`

### 格式：
```
CALL <$DLL文件及路径>
```
### 功能：
调用DLL文件进行注册右键等操作。

### 参数： 
前导“$”表示调用DLL文件，指定DLL路径、函数名和参数。省略函数名，将调用“Dll注册服务”。

### 示例：
```
CALL $%SystemRoot%\SHELL32.DLL
```

## `DEVI`

### 格式：
```
DEVI <$CAB文件及路径>
```

### 功能：
从CAB文件或指定的文件夹中查找(并安装)驱动程序。

### 参数： 
`\路径名`指定CAB文件路径。前导“$”表示解压缩驱动文件后安装驱动，否则不安装。

### 示例”：
```
DEVI $%SystemRoot%\DRV.CAB
```

## `DISP`

### 格式：
```
DISP \[W水平分辨率 H垂直分辨率] \[B颜色深度] \[F刷新率] \[T等待(毫秒)]
```

### 功能：
设置屏幕显示分辨率等。

### 参数：
`\参数名`分别指定屏幕参数，如果省略则使用默认配置；前三组参数可单独使用，如要单独设置刷新率为90，使用`DISP F90`即可。

### 示例：
```
DISP W1024 H768 B32 F70 T5000
```

## `EXEC`

### 格式：
```
EXEC [=]\[!]\[@]\[$]\[&]\路径名\程序名 [-软件参数]
```

### 功能：
执行EXE、BAT、CMD程序。

### 参数： 
* `\路径名`指定程序路径；
* 前导“=”表示等待执行完成；
* 前导“!”表示隐藏方式执行； 
* 前导“@”表示后台隐藏运行；
* 前导“$”用于打开非可执行文件(如.TXT等)。

### 示例：
```
EXEC !%ProgramFiles%\WinXShell\WinXShell.exe -regist -daemon
```

## `FILE`

### 格式：
```
FILE <文件路径>\[操作符]\[目标路径]
```
### 功能：
操作文件或目录。

### 参数：
* `\路径名`指定源文件和目标路径，支持通配符，可用分号同时操作多个文件；
* 操作符“->”、“=>”分别对应移动、复制操作，没有操作符则表示删除操作。

### 示例：
```
FILE %SystemRoot%\INF\*.INF => %TEMP%
```

## `FIND`

### 格式：
```
FIND <条件>,\[命令1]\[!命令2]
```

### 功能：
一般用于查找文件依据条件表达式是否成立，成立则执行命令1，不成立则执行命令2。

### 参数：  
* 条件指对[内存总数]或[磁盘总空间]或[按键]或[环境变量]或[内存进程]的判断；  
* 内存总数 —— MEM<比较符>数值；  
* 磁盘总空间 —— C:\<比较符>数值，C:表示盘符；  
* 按键 —— KEY<比较符>数值；  
* 内存进程 —— 内存进程名；
* 环境变量 —— $%环境变量名%<比较符>环境变量值，环境变量的比较不区分大小写； 
* 比较符 —— 比较操作符为“<”、“>”、“=”，分别表示“小于”、“大于”、“等于”；  
* 数值比较写数值，磁盘和内存单位是MB，按键数值写按键代码。

### 示例：
```
FIND MEM<128,SHEL %SystemRoot%\SYSTEM32\XPLORER2.EXE!SHELL %SystemRoot%\EXPLORER.EXE
```
```
FIND $%OUTSIDE%=,ENVI $OUTSIDE\=%CurDrv%\外置程序
```

::: tip 提示
* 本命令功能强大，较为复杂，且可嵌套(`FIND`或`IFEX`)使用，判断多个条件，`IFEX`命令功能与其相似；  
* <条件表达式>后的“,”号也可用“*”号代替；  
* 本命令嵌套`FIND`或`IFEX`命令时，被嵌套的命令中不能使用“!”分隔符；  
* 当`FIND`命令用于检测按键时，若用户按了‘A’～’Z’或‘0’～’9′这些键，按键结果将保存在环境变量`%PressKey%`中。
:::

## `FORX`

### 格式：
```
FORX \[@]\[!]<文件>,<变量>,\[数值],<命令> \[参数]<%变量%>\[参数]
```

### 功能：
对匹配的文件目录进行对应的命令操作。

### 参数：  
* 文件: 指定文件目录名，可带通配符；  
* 变量: 指定变量名，但不能是已存在的环境变量名； 
* 数值: 对匹配的文件目录执行相应次数的命令操作，“0”或“<0”表示对所有存在的文件执行命令操作；
* 命令: PECMD.EXE合法有效的命令，命令后的参数格式和个数由该命令而定；
* 前导“\\”表示搜索所有分区，“!”表示对所有分区进行逆序搜索，但“!”不能单独存在；
* 前导“@”表示仅搜索目录并进行相应操作，省略该前导表示仅搜索文件并进行相应操作。    

### 示例：
```
FORX %CurDir%\Path1\*.DLL,AnyDLL,0,CALL %AnyDLL%
```
```
FORX !\WinPE\\WinPE.INI,MyIni,1,LOAD %MyIni%
```

## `HOTK`

### 格式：
```
HOTK \[辅助按键 + <#虚拟按键代码>],<命令>
```

### 功能：
设置系统热键，并指定该热键执行的命令(.EXE或.CMD或.BAT)。

### 参数：  
Ctrl或Alt可用字符串直接表示，其它按键用虚拟按键代码，为16进制数值。

### 附件：  
**16进制字母对应一览表：**
| 16进制 |对应字母|
|---------|--------|
|#0x41|A|
|#0x42|B|
|#0x43|C|
|#0x44|D|
|#0x45|E|
|#0x46|F|
|#0x47|G|
|#0x48|H|
|#0x49|I|
|#0x4A|J|
|#0x4B|K|
|#0x4C|L|
|#0x4D|M|
|#0x4E|N|
|#0x4F|O|
|#0x50|P|
|#0x51|Q|
|#0x52|R|
|#0x53|S|
|#0x54|T|
|#0x55|U|
|#0x56|V|
|#0x57|W|
|#0x58|X|
|#0x59|Y|
|#0x5A|Z|
### 示例：
```
HOTK Ctrl + Alt + #36,PECMD.EXE
```

## `IFEX`

### 格式：
```
IFEX <条件>,[命令1]\[!命令2]
```

### 功能：
依据条件表达式是否成立，成立则执行命令1，不成立则执行命令2。

### 参数：  
* 条件指对[内存总数]或[磁盘总空间]或[按键]或[环境变量]或[内存进程]的判断；  
* 内存总数 —— MEM<比较符>数值；  
* 磁盘总空间 —— C:\<比较符>数值，C:表示盘符；  
* 按键 —— KEY<比较符>数值；  
* 内存进程 —— 内存进程名；
* 环境变量 —— $%环境变量名%<比较符>环境变量值，环境变量的比较不区分大小写； 
* 比较符 —— 比较操作符为“<”、“>”、“=”，分别表示“小于”、“大于”、“等于”；  
* 数值比较写数值，磁盘和内存单位是MB，按键数值写按键代码。

### 示例：
```
IFEX Z:\SYSTEM,!SHUT
```

::: tip 提示
* 本命令功能强大，较为复杂，且可嵌套(`FIND`或`IFEX`)使用，判断多个条件，`FIND`命令功能与其相似；  
* <条件表达式>后的“,”号也可用“*”号代替；  
* 本命令嵌套`FIND`或`IFEX`命令时，被嵌套的命令中不能使用“!”分隔符；  
* 当`FIND`命令用于检测按键时，若用户按了‘A’～’Z’或‘0’～’9′这些键，按键结果将保存在环境变量`%PressKey%`中；
* 本命令用于变量判断时，所有变量均按Double型来处理(最多保留4位小数)。
:::

## `KILL`

### 格式：
```
KILL \路径名\[进程名称]
```

### 功能：
关闭指定标题的窗口或强制终止指定的进程。

### 示例：
```
KILL WinLogon.EXE
```

## `LINK`

### 格式：
```
LINK \[!]<快捷方式路径>,<目标路径>,\[-运行参数],\[图标路径 + #图标索引]
```

### 功能：
创建快捷方式。

### 参数：  
* 快捷方式：指定要生成的快捷方式的路径，不需要“.LNK”扩展名；  
* 目标路径：指定快捷方式的目标文件目录(可用相对路径)；
* 运行参数：目标程序运行参数； 
* 图标路径：快捷方式图标的路径；  
* 图标索引：快捷方式图标在文件资源中序号，0为第1个，不填则默认。  

### 示例：
```
LINK %StartMenu%\F1 刷新系统,Pecmd.exe, KILL explorer.exe,shell32.dll#238
```

## `LOAD`

### 格式：
```
LOAD <文件路径>
```

### 功能：
按顺序逐条运行配置文件中的命令。

### 参数： 
如果文件路径第1个字符是“\”，则搜索所有磁盘指定目录中的文件。  

### 示例：
```
LOAD \%SystemRoot%\System32\PECMD.INI
```

## `NUMK`

### 格式：
```
NUMK <数值>
```

### 功能：
控制小数字键盘的开关状态。

### 参数：  
数值0时为关，1时为开。

### 示例：
```
NUMK 0
```

## `REGI`

### 格式：
```
REGI [前导]<HKLM|HKCU|HKCR|HKU|HKCC><\子项\>{<键名,变量名>|[[键名][操作符][[类型符]数据值]]}
```

### 功能：
读取或设置、删除注册表数据。

### 参数：  
* 前导符 "$"/"#"/"@" 分别表示读取注册表中的REG_SZ/REG_DWORD/REG_BINARY类型数据，省略表示设置、删除注册表数据。变量名(默认为RegDat)用于保存返回值; 
* 子项名所选ROOTKEY下注册表项的完整名；  
* 键值名要操作的键值名。省略则操作默认键值，如果操作符为"!"且没有"="，则用于删除整个子项；  
* 操作符操作符"!"为删除整个子项，操作符"="且没有数据为删除，操作符"="且有数据为设置数据；  
*  数据值字符串空值用""表示，REG_DWORD类型数据、REG_BINARY类型数据支持16进制数值。

### 示例：
```
REGI $HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders\Cache,IECache
```

::: tip 提示
* 此命令比较复杂，请仔细看说明，示例为读取IE缓存的位置。
:::

## `SERV`

### 格式：
```
SERV \[!]<服务名称>
```

### 功能：
启动或停止服务或驱动程序。

### 参数：  
前导“!”表示停止服务，否则启动服务。

### 示例：
```
SERV MSiSCSI
```

## `SHEL`

### 格式：
```
SHEL explorer.exe
```

### 功能：
启动Explorer。

## `TEAM`

### 格式：
```
TEAM \[命令]
```

### 功能：
按顺序预执行指定命令群中的各命令。

### 参数：  
* 一条或多条命令，多命令之间用“|”分开。
* 本命令后不能嵌入IFEX或FIND命令。

### 示例：
```
TEAM FILE %public%\Desktop\desktop.ini|FILE %Desktop%\desktop.ini
```

## `WAIT`

### 格式：
```
WAIT \[-]\[等待时间]
```

### 功能：
暂停或等待指定时间后再继续执行命令。

### 参数：  
* 前导“-”：在指定的等待时间内遇到任何按键即中止等待，否则直至等待时间结束；  
* 等待时间: 数值(单位：毫秒)，数值为0时遇到按键即中止，若无按键会无限等待。 

### 示例：
```
WAIT 2000
```

## `WALL`

### 格式：
```
WALL <壁纸文件名>
```

### 功能：
设置壁纸。

### 示例：
```
WALL %SystemRoot%\System32\Web\Wallpaper\Windows\img0.jpg
```

::: warning 注意
设置壁纸的`WALL`必须放在加载桌面`SHEL`命令之前！
:::